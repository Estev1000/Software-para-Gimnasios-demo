<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FitPro - Registro de Ingresos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Poppins',sans-serif;background:#f5f7fa;}
        .card{box-shadow:0 10px 25px rgba(0,0,0,.08);border:none;border-radius:15px;}
        .btn-primary-custom{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;}
        .btn-primary-custom:hover{transform:translateY(-2px);}
    </style>
</head>
<body>
<div class="container py-5">
    <div class="d-flex justify-content-end mb-3">
        <a href="index.html" class="btn btn-outline-primary"><i class="fas fa-arrow-left me-2"></i>Volver al Panel</a>
    </div>
    <h2 class="mb-4 text-center"><i class="fas fa-door-open me-2"></i>Registro de Ingresos</h2>
    <div class="card p-4 mb-4">
        <form id="formBuscar" class="row g-2 align-items-end">
            <div class="col-sm-4">
                <label class="form-label">ID del Miembro</label>
                <input type="number" id="inputMiembro" class="form-control" required>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary-custom btn-custom" type="submit"><i class="fas fa-search me-2"></i>Buscar</button>
            </div>
        </form>
        <div id="resultadoBusqueda" class="mt-4 d-none">
            <h5>Miembro:</h5>
            <p id="nombreMiembro" class="fw-semibold mb-2"></p>
            <button id="btnRegistrar" class="btn btn-success btn-custom"><i class="fas fa-door-open me-2"></i>Registrar Ingreso</button>
        </div>
    </div>

    <div class="card p-4">
        <h5 class="mb-3"><i class="fas fa-history me-2"></i>Historial de Ingresos</h5>
        <table id="tablaIngresos" class="table table-striped table-custom w-100">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Miembro ID</th>
                    <th>Fecha/Hora</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// GymStorage (simplificado, idéntico al usado en index.html)
class GymStorage{
    constructor(){this.init();}
    init(){
        if(!localStorage.getItem('gym_usuarios'))localStorage.setItem('gym_usuarios','[]');
        if(!localStorage.getItem('gym_ingresos'))localStorage.setItem('gym_ingresos','[]');
        if(!localStorage.getItem('gym_next_id'))localStorage.setItem('gym_next_id','1');
    }
    getNextId(){const n=parseInt(localStorage.getItem('gym_next_id'));localStorage.setItem('gym_next_id',String(n+1));return n;}
    getUsuarios(){return JSON.parse(localStorage.getItem('gym_usuarios')||'[]');}
    getUsuario(id){return this.getUsuarios().find(u=>u.id===parseInt(id));}
    getIngresos(){return JSON.parse(localStorage.getItem('gym_ingresos')||'[]');}
    addIngreso(i){const arr=this.getIngresos();i.id=this.getNextId();arr.push(i);localStorage.setItem('gym_ingresos',JSON.stringify(arr));}
}
const storage=new GymStorage();

// DataTable
const dt=$('#tablaIngresos').DataTable({language:{search:'Buscar:',lengthMenu:'Mostrar _MENU_',info:'_START_ - _END_ de _TOTAL_',paginate:{first:'Primero',last:'Último',next:'Siguiente',previous:'Anterior'},emptyTable:'Sin registros'},order:[[0,'desc']]});
function refrescarTabla(){
    const data=storage.getIngresos().map(i=>[i.id,i.usuario_id,new Date(i.fecha).toLocaleString('es-ES')]).sort((a,b)=>b[0]-a[0]);
    dt.clear().rows.add(data).draw();
}
refrescarTabla();

// Buscar miembro
$('#formBuscar').on('submit',function(e){e.preventDefault();const id=$('#inputMiembro').val();const u=storage.getUsuario(id);if(u){$('#nombreMiembro').text(`${u.nombre} ${u.apellido}`);$('#btnRegistrar').data('uid',id);$('#resultadoBusqueda').removeClass('d-none');}else{alert('Miembro no encontrado');$('#resultadoBusqueda').addClass('d-none');}});

// Registrar ingreso
$('#btnRegistrar').on('click',function(){const id=$(this).data('uid');const u=storage.getUsuario(id);if(!u){alert('Miembro no encontrado');return;}storage.addIngreso({usuario_id:id,fecha:new Date().toISOString()});alert('Ingreso registrado');$('#resultadoBusqueda').addClass('d-none');$('#inputMiembro').val('');refrescarTabla();});
</script>
</body>
</html>